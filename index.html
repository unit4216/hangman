<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8'>
        <title>Hang Me</title>

        <!--React/Babel-->
        <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></script>

        <!--Bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        
        <!--JQuery-->
        <script type= "text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

        <!--Reactstrap-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/reactstrap/4.8.0/reactstrap.min.js" ></script>
        
        <!--Alertify.js-->
        <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"/>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"/>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/semantic.min.css"/>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css"/>


    </head>

    <style>
        h1 {font-size:60px}
        #start {border-radius:0px; border: 3px solid black;font-size:20px}
    </style>

    <body>

        <!--splash screen-->
        <div id="splash" style='height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column'>
            <h1>Hang Me</h1>
            <br>        
            <button href="#" class="btn btn-outline-dark" id='start'>PLAY</button>
        </div>

        <!--App-->
        <div class='container' id='hangApp' style='position:absolute;top:0;left:0;z-index:-1;display:none'>
            <div class='row'>
                <div class='col-md-2'></div>
                <div class='col-md-10'>
                    <div id='app'><!--App goes here--></div>
                </div>
            </div>
        </div>
    </body>

    <script>
        //splash screen "enter" function, fades out splash screen and fades in app
        $('#start').click(function() { 
            $(this).parent().fadeOut(500);
            $('#hangApp').fadeIn(500);
        });
    </script>

    <script type='text/babel'>

        function App(props){

            

            return(
                <div style={{marginTop:'50px'}}>
                    <div style={{display:'inline-block',verticalAlign:'middle'}}><Hangman /></div>
                    <div style={{display:'inline-block',verticalAlign:'middle',margin:'auto',width:'45%'}}><FillInWord /></div>
                </div>
            );
        }

        function Hangman(props){

            //draws initial hangman state
            function hangmanOnLoad(){
                var canvas = document.getElementById("hangman");
                var ctx = canvas.getContext('2d');

                ctx.lineWidth = 10;
                ctx.fillStyle='#000000';
                ctx.beginPath();
                ctx.moveTo(100,400);
                ctx.lineTo(400,400);
                ctx.stroke();

                ctx.moveTo(150, 100);
                ctx.lineTo(150, 400);
                ctx.stroke();

                ctx.moveTo(150, 100);
                ctx.lineTo(300, 100);
                ctx.stroke();

                ctx.moveTo(300, 100);
                ctx.lineTo(300, 150);
                ctx.stroke();
            
            }

            $( document ).ready(function() {
                hangmanOnLoad();
            });

            return(
                <div>
                    <canvas id='hangman' width='500' height='500' >Your browser doesn't support canvas.</canvas>
                </div>
            )
        }

        function FillInWord(props){
            const [word, setWord] = React.useState('');
            const [wordDisplay, setWordDisplay] = React.useState('');
            //const [underscore, setUnderscore] = React.useState('');
            const [currentLetter, setCurrentLetter] = React.useState('');
            const [lettersGuessed, setLettersGuessed] = React.useState([]);
            const [errorCount, setErrorCount] = React.useState(1);
            const [score, setScore] = React.useState([0,0]);


            //get word from backend
            function getWord(){

                //AJAX call to backend to get word to be used
                $.ajax({
                    url: '/getWord',
                    data: '',
                    type: 'GET',
                    
                    success: function(data){
                        setWord(data.WORD);
                        //var under='_ ';
                        //setUnderscore(under.repeat(data.WORD.length));
                        var space='_';
                        setWordDisplay(space.repeat(data.WORD.length));
                        console.log(data.WORD);
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("Error getting word");
                    }

                });
            }      

            //only getWord if current state is empty 
            if(word==''){
                getWord();
            }
        

            //define alphabet list for validating input
            var alphabet=['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];

            //checks if user has won (i.e. when word and wordDisplay are equal) and resets screen and relevant vars. 
            React.useEffect(()=>{
                if(word==wordDisplay && word!= '' && wordDisplay!=''){
                    //init canvas draw functions
                    var canvas = document.getElementById("hangman");
                    var ctx = canvas.getContext('2d');
                    //game over - get new Word, clear hangman off canvas, reset errorCount & lettersGuessed
                    getWord();
                    ctx.clearRect(245, 145, 110, 190); //x start, y start, rect width, rect height
                    setErrorCount(1);
                    setLettersGuessed([]);
                    setScore([score[0]+1,score[1]]); //update score (add 1 win)
                }
            },[wordDisplay]);            //function only runs when wordDisplay state is updated.

          
            //have to useEffect so that I can setup and remove each keypress listener on each render (so that they don't multiply)
            React.useEffect(() => {


                //listen for key presses
                $('html').keypress(function(e) {

                    //if input is a valid letter, setCurrentLetter to it
                    if(alphabet.includes(String.fromCharCode(e.keyCode))){
                        setCurrentLetter(String.fromCharCode(e.keyCode));
                    }


                    //if user presses enter, run main function (check if letter is in word etc)
                    else if(e.keyCode==13){
                        //console.log(currentLetter)
                        
                        //check if currentLetter is in Word
                        //if currentLetter is in Word and not null, update displayWord
                        if(word.includes(currentLetter)==true && currentLetter != ''){
                            //console.log(currentLetter + ' in word')

                            //generate list of indices where letter occurs in Word
                            var letterIndices = [];
                            for(var i=0; i<word.length;i++){
                                if(word[i]===currentLetter){
                                    letterIndices.push(i);
                                }
                            }

                            //use indices of currentLetter in Word to add correctly guessed letters to displayWord
                            var tempWD = wordDisplay;
                            for(var j=0; j<letterIndices.length; j++){
                                tempWD=tempWD.substring(0, letterIndices[j]) + currentLetter + tempWD.substring(letterIndices[j] + 1);
                            }
                            setWordDisplay(tempWD);

                        }
                        //if currentLetter isn't in Word and hasn't already been guessed, draw next part of Hangman
                        else if(word.includes(currentLetter)==false && lettersGuessed.includes(currentLetter + ' ')==false){
                            //console.log(currentLetter + ' not in word')
                            //console.log(errorCount)

                            //add letter guessed to lettersGuessed array
                            var lettersGuessedCopy = [...lettersGuessed];
                            lettersGuessedCopy.push(currentLetter + ' ');
                            setLettersGuessed(lettersGuessedCopy);

                            //increment errorCount to draw next body part in sequence
                            setErrorCount(errorCount+1)

                            //init canvas draw functions
                            var canvas = document.getElementById("hangman");
                            var ctx = canvas.getContext('2d');
                            ctx.lineWidth = 10;


                            //draw body parts
                            if(errorCount==1){                          //head
                                ctx.beginPath();
                                ctx.arc(300, 170, 20, 0, 2 * Math.PI);
                                ctx.stroke();
                            }
                            else if(errorCount==2){                     //body
                                ctx.beginPath();
                                ctx.moveTo(300,190);
                                ctx.lineTo(300,300);
                                ctx.stroke();
                            }
                            else if(errorCount==3){                     //left arm
                                ctx.beginPath();
                                ctx.moveTo(300,220);
                                ctx.lineTo(250,250);
                                ctx.stroke();
                            }
                            else if(errorCount==4){                     //right arm
                                ctx.beginPath();
                                ctx.moveTo(300,220);
                                ctx.lineTo(350,250);
                                ctx.stroke();
                            }
                            else if(errorCount==5){                     //left leg
                                ctx.beginPath();
                                ctx.moveTo(300,300);
                                ctx.lineTo(250,330);
                                ctx.stroke();
                            }
                            else if(errorCount==6){                     //right leg
                                ctx.beginPath();
                                ctx.moveTo(300,300);
                                ctx.lineTo(350,330);
                                ctx.stroke();

                                //game over - get new Word, clear hangman off canvas, reset states and alert correct answer
                                getWord();
                                ctx.clearRect(245, 145, 110, 190); //x start, y start, rect width, rect height
                                setErrorCount(1);
                                setLettersGuessed([]);
                                setScore([score[0],score[1]+1]); //update score (add 1 loss)
                                setCurrentLetter('');
                                alertify.alert('YOU LOSE', 'The correct word was ' + word).setting({transition:'fade'});

                            }
                            
                        }
                    }
                    

                });

            return () => { $('html').unbind() } //unbind keypress listener after each use so that you're not spawning a million listeners

            });


            return(
                <div style={{textAlign:'center'}}>
                    <h1 style={{letterSpacing:'15px'}}>{wordDisplay}</h1>
                    <h1>{currentLetter}<span class='nonBreakingSpaceToHoldLineOpen'>&nbsp;</span></h1>
                    <h3>Letters guessed: <br />{lettersGuessed}<span class='nonBreakingSpaceToHoldLineOpen'>&nbsp;</span></h3>
                    <h3>Wins: {score[0]} Losses: {score[1]}</h3>
                </div>
            )
        }


        ReactDOM.render(<App />, document.getElementById('app'));

    </script>


</html>